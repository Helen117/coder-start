<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>树的展开折叠</title>
    <script src="https://unpkg.com/react@15/dist/react.min.js"></script>
    <script src="https://unpkg.com/react-dom@15/dist/react-dom.min.js"></script>
    <script src="https://a.alipayobjects.com/g/datavis/g2/2.3.0/g2.js"></script>
    <script src="https://unpkg.com/g2-react@1.2.0/dist/index.js"></script>
    <script src="https://cdn.bootcss.com/babel-core/5.8.38/browser.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
<div id="c1"></div>
<style type="text/css">
    .ac-tooltip{
        position:absolute;
        border : 1px solid #efefef;
        background-color: white;
        opacity: .8;
        padding: 5px 15px;
        transition: top 200ms,left 200ms;
        -moz-transition:  top 200ms,left 200ms;  /* Firefox 4 */
        -webkit-transition:  top 200ms,left 200ms; /* Safari 和 Chrome */
        -o-transition:  top 200ms,left 200ms;
        border-radius: 5px;
    }

    #c4{
        padding: 5px;
        width: 200px;
        background-color: #3D3D3D;
        color: white;
        border-radius: 5px;
    }
</style>
<script type="text/babel">
    function renderTree(nodes, edges, dx, chart) {
        chart.clear();
        var height = Math.max(500, 26 / dx); // 最小高度 500
        chart.changeSize(1000, height);
        // 首先绘制 edges，点要在边的上面
        // 创建单独的视图
        var edgeView = chart.createView();
        edgeView.source(edges);
        edgeView.coord().transpose().scale(1, -1); //
        edgeView.axis(false);
        edgeView.tooltip(false);
        // Stat.link 方法会生成 ..x, ..y的字段类型，数值范围是 0-1
        edgeView.edge()
                .position(Stat.link('source*target',nodes))
                .shape('smooth')
                .color('#ccc');
        function strLen(str) {
            var len = 0;
            for (var i = 0; i < str.length; i ++) {
                if(str.charCodeAt(i) > 0 && str.charCodeAt(i) < 128) {
                    len ++;
                } else {
                    len += 2;
                }
            }
            return len;
        }
        // 创建节点视图
        var nodeView = chart.createView();
        nodeView.coord().transpose().scale(1, -1); //'polar'
        nodeView.axis(false);
        // 节点的x,y范围是 0，1
        // 因为边的范围也是 0,1所以正好统一起来
        nodeView.source(nodes, {
            x: {min: 0,max:1},
            y: {min: 0, max:1},
            value: {min: 0}
        },['id','x','y','name','children','collapsed']); // 由于数据中没有 'collapsed' 字段，所以需要设置所有的字段名称
        nodeView.point().position('x*y').color('steelblue').size('name', function(name) {
            var length = strLen(name);
            return length * 6 + 5 * 2;
        }).label('name', {
            offset: 6,
            labelEmit: true
        })
                .shape('children*collapsed', function(children,collapsed) {
                    if (children) {
                        if (collapsed) {
                            return 'collapsed';
                        } else {
                            return 'expanded';
                        }
                    }
                    return 'leaf';
                })
                //.tooltip('name*id');
        chart.render();
    }
    function drawNode(cfg, group, collapsed, isLeaf) {
        var x = cfg.x;
        var y = cfg.y;
        var pointSize = 5;
        var width = cfg.size;
        var height = 18;
        var label = cfg.label;
        var shape = group.addShape('rect', {
            attrs: {
                x: x,
                y: y - height / 2 ,
                width: width,
                height: height,
                fill: '#fff',
                cursor: isLeaf ? '' : 'pointer',
                stroke: cfg.color
            }
        });
        if (!isLeaf) {
            x = x - pointSize;
            group.addShape('circle', {
                attrs: {
                    r: pointSize,
                    x: x,
                    y: y,
                    fill: '#fff',
                    stroke: cfg.color // 可以直接设置颜色 cfg.color，也可以使用映射
                }
            });
            var path = [];
            path.push(['M', x - pointSize/2, y]);
            path.push(['L', x + pointSize/2, y]);
            if (collapsed) {
                path.push(['M', x, y - pointSize/2]);
                path.push(['L', x, y + pointSize/2]);
            }
            group.addShape('path', {
                attrs: {
                    path: path,
                    stroke: cfg.color
                }
            });
        }
        return shape;
    }
    const Chart = createG2(chart => {
        G2.Shape.registShape('point', 'collapsed', {
            drawShape: function(cfg, group) {
                return drawNode(cfg, group, true)
            }
        });
        G2.Shape.registShape('point', 'expanded', {
            drawShape: function(cfg, group) {
                return drawNode(cfg, group, false);
            }
        });
        G2.Shape.registShape('point', 'leaf', {
            drawShape: function(cfg, group) {
                return drawNode(cfg, group, false, true);
            }
        });
        var data = chart.get('data').data;
        var Layout = G2.Layout;
        var Stat = G2.Stat;
        // 使用layout，用户可以自己编写自己的layout
        // 仅约定输出的节点 存在 id,x，y字段即可
        var layout = new Layout.Tree({
            nodes: data
        });
        var dx = layout.dx;
        var nodes = layout.getNodes();
        var edges = layout.getEdges();
        chart.animate(false);
        // 不显示title
        chart.tooltip({
            title: null
        });
        chart.tooltip(true, {
            offset: 10,
            custom: true,
            html: '#p1'
        });
        chart.legend('children', false);
        chart.legend('name', false);
        renderTree(nodes, edges, dx, chart);

        // 查找对应的数据
        function findObj(name,data) {
            let result;
            const data_temp = data.map((item)=>{
                console.log('name,item:',name,item)
                if(name == item.name){
                    return item;
                }else if(item.children){
                    return findObj(name,item.children)
                }
            });
            for(let i=0; i<data_temp.length; i++){
                if(data_temp[i]){
                    result = data_temp[i];
                }
            }

            return result;
        }
        // 监听 tooltip 改变事件
        chart.on('tooltipchange', function(ev) {
            console.log('tooltipchange');
            var item = ev.items[0]; // 获取tooltip要显示的内容
            console.log('item:',item)
            var name = item.name;
            var obj = findObj(name,data);
            let desc = document.getElementById('c4');
            desc.innerHTML=obj.description?obj.description:"无";
        });

        chart.on('plotclick', function(ev){
            var shape = ev.shape;
            if (shape) {
                var obj = shape.get('origin');
                var id = obj._origin.id;
                var node = layout.findNode(id);
                if (node && node.children) {
                    node.collapsed = !node.collapsed ? 1 : 0;
                    layout.reset();
                    nodes = layout.getNodes();
                    edges = layout.getEdges();
                    dx = layout.dx;
                    // edgeView.changeData(edges);
                    renderTree(nodes, edges, dx, chart);
                }
            }
        });
    });

    const HiddenStyle = {
        display: 'none'
    };
    const pieContainerStyle = {
        position: 'absolute',
        visibility: 'hidden',
        border : '1px solid #efefef',
        backgroundColor: 'white',
        opacity: '.8',
        padding: '5px',
        transition: 'top 200ms,left 200ms',
    };

    const MyComponent = React.createClass({
        getInitialState() {
            return {
                data: [{"name":"flare","description":"111111111111111111","children":[
                        {"name":"analytics","description":"2222222222222222","children":[
                                {"name":"cluster","description":"333333333","children":[
                                        {"name":"AgglomerativeCluster","description":"444","size":3938},
                                    {"name":"CommunityStructure","description":"555","size":3812},
                                    {"name":"HierarchicalCluster","description":"666","size":6714},
                                    {"name":"MergeEdge","description":"777","size":743}]}]}]}],
                forceFit: true,
                width: 500,
                height: 450,
                plotCfg: {
                    margin: [20,50]
                },
            };
        },
        render() {
            return (
                    <div>
                        <div style={HiddenStyle}>
                            <div id="p1" className="ac-tooltip" style={pieContainerStyle}>
                                <span>描述</span>
                                <div id="c4"></div>
                            </div>
                        </div>

                        <Chart
                                data={this.state.data}
                                width={this.state.width}
                                height={this.state.height}
                                plotCfg={this.state.plotCfg}
                                forceFit={this.state.forceFit} />
                    </div>
            );
        },
    });
    ReactDOM.render(<MyComponent />, document.getElementById('c1'));
</script>
</body>
</html>
